<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Danfoss Ally – Internal Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --brand-red: #e2001a;
      --brand-red-600: #c00016;
      --brand-red-700: #a20013;
      --bg-0: #fafafa;
      --bg-1: #f5f6f8;
      --gray-50: #fafafa;
      --gray-100: #f0f1f3;
      --gray-200: #e6e8eb;
      --gray-300: #d7dbe0;
      --gray-500: #9aa3af;
      --gray-600: #6b7280;
      --gray-700: #374151;
      --shadow-sm: 0 1px 2px rgba(0,0,0,.06), 0 1px 6px rgba(0,0,0,.04);
      --shadow-md: 0 4px 12px rgba(0,0,0,.08);
    }
    html { min-height: 100%; background: linear-gradient(180deg, var(--bg-0), var(--bg-1)); }
    body { min-height: 100%; background: transparent; color: #111827; }
    a { color: var(--brand-red); text-decoration: none; }
    a:hover { color: var(--brand-red-600); text-decoration: underline; }

    /* Cards (grid) */
    .card-device {
      border: 1px solid var(--gray-200);
      background: linear-gradient(180deg, #ffffff, #fdfdfd);
      box-shadow: var(--shadow-sm);
      transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .card-device:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--gray-300); }

    .device-type { color: var(--gray-600); font-size: .9rem; }
    .device-name { color: var(--brand-red); font-weight: 600; letter-spacing: .2px; }
    .temp-value { font-size: 2.25rem; font-weight: 600; line-height: 1.1; }
    .badge-status { font-size: .75rem; }
    .badge-dark { background-color: var(--gray-700); color: #fff; }
    .temp-low { color: var(--brand-red); }
    .status-pill { display:inline-block; padding: 2px 8px; border-radius: 9999px; font-size:.75rem; border:1px solid var(--gray-300); color: var(--gray-700); background: var(--gray-50); }
    .status-heating { background:#fee2e2; border-color:#fecaca; color:#991b1b; }
    .status-preheat { background:#fff7ed; border-color:#fed7aa; color:#9a3412; }

    /* Bottom links container spacing */
    .container.mb-4 a { font-weight: 400; }

    /* Buttons (Danfoss red) */
    .btn-primary { background-color: var(--brand-red); border-color: var(--brand-red); }
    .btn-primary:hover { background-color: var(--brand-red-600); border-color: var(--brand-red-600); }
    .btn-primary:focus { box-shadow: 0 0 0 .25rem rgba(226,0,26,.25); }
    .btn-outline-primary { color: var(--brand-red); border-color: var(--brand-red); }
    .btn-outline-primary:hover { color: #fff; background-color: var(--brand-red); border-color: var(--brand-red); }

    /* Inputs */
    .form-control { border-color: var(--gray-300); }
    .form-control:focus { border-color: var(--brand-red); box-shadow: 0 0 0 .2rem rgba(226,0,26,.15); }

    /* Modals */
    .modal-content { border: 1px solid var(--gray-200); box-shadow: var(--shadow-md); }
    .modal-header { background: linear-gradient(180deg, #ffffff, var(--gray-50)); border-bottom: 1px solid var(--gray-200); }
    .modal-footer { background: linear-gradient(0deg, #ffffff, var(--gray-50)); border-top: 1px solid var(--gray-200); }

    /* Tables */
    .table thead th { color: #374151; border-bottom: 1px solid var(--gray-300); background: var(--gray-50); }
    .table tbody td { vertical-align: middle; }

    /* Utility */
    .touch-target { min-height: 44px; }

    /* Sparklines */
    .sparkline { height: 36px; }
    .sparkline path { stroke: var(--brand-red); stroke-width: 1.5; fill: none; opacity: .9; stroke-linejoin: miter; stroke-linecap: round; }
    .sparkline .grid { stroke: var(--gray-200); stroke-width: 1; opacity: .7; }
    /* Metrics inline */
    .metrics-inline { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; margin-bottom: 0; padding: 0; list-style: none; }
    .metrics-inline .chip { display: inline-flex; align-items: center; gap: 4px; border: 1px solid var(--gray-300); background: #fff; border-radius: 9999px; padding: 2px 8px; font-size: .78rem; color: #374151; }
    .metrics-inline .label { color: var(--gray-600); }

    /* Type backgrounds - very light grays (intensified) */
    .type-bg-0 { background: linear-gradient(180deg, #ffffff, #f1f1f1); border-color: #e3e3e3; border-left: 3px solid #d9d9d9; }
    .type-bg-1 { background: linear-gradient(180deg, #ffffff, #efefef); border-color: #e1e1e1; border-left: 3px solid #d6d6d6; }
    .type-bg-2 { background: linear-gradient(180deg, #ffffff, #ededed); border-color: #dfdfdf; border-left: 3px solid #d3d3d3; }
    .type-bg-3 { background: linear-gradient(180deg, #ffffff, #ececec); border-color: #dedede; border-left: 3px solid #d1d1d1; }
    .type-bg-4 { background: linear-gradient(180deg, #ffffff, #ebebeb); border-color: #dcdcdc; border-left: 3px solid #cfcfcf; }
    .type-bg-5 { background: linear-gradient(180deg, #ffffff, #e9e9e9); border-color: #dadada; border-left: 3px solid #cdcdcd; }
    .type-bg-6 { background: linear-gradient(180deg, #ffffff, #e8e8e8); border-color: #d8d8d8; border-left: 3px solid #cacaca; }
    .type-bg-7 { background: linear-gradient(180deg, #ffffff, #e7e7e7); border-color: #d6d6d6; border-left: 3px solid #c7c7c7; }
    .type-bg-8 { background: linear-gradient(180deg, #ffffff, #e6e6e6); border-color: #d4d4d4; border-left: 3px solid #c5c5c5; }
    .type-bg-9 { background: linear-gradient(180deg, #ffffff, #e5e5e5); border-color: #d2d2d2; border-left: 3px solid #c2c2c2; }
    .type-bg-10 { background: linear-gradient(180deg, #ffffff, #e3e3e3); border-color: #d0d0d0; border-left: 3px solid #c0c0c0; }
    .type-bg-11 { background: linear-gradient(180deg, #ffffff, #e2e2e2); border-color: #cecece; border-left: 3px solid #bdbdbd; }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark d-none">
    <div class="container">
      <span class="navbar-brand">Danfoss Ally – Internal Dashboard</span>
      <div class="text-light small" id="tokenInfo">Not connected</div>
    </div>
  </nav>
  <main class="container my-4">
    <div id="hiddenModeAlert" class="alert alert-warning d-none">
      <strong>Viewing hidden devices</strong>
      <button id="showActiveBtn" class="btn btn-sm btn-outline-dark ms-3">Show active</button>
    </div>
    <div class="card mb-3 d-none">
      <div class="card-header d-flex align-items-center">
        <span>Settings</span>
        <button class="btn btn-link ms-auto" data-bs-toggle="collapse" data-bs-target="#settingsBody" aria-expanded="true">Show / Hide</button>
      </div>
      <div id="settingsBody" class="collapse show">
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-md-5">
              <label class="form-label">Customer Key</label>
              <input id="clientIdInput" class="form-control" placeholder="Enter Customer Key">
            </div>
            <div class="col-md-5">
              <label class="form-label">Customer Secret</label>
              <input id="clientSecretInput" type="password" class="form-control" placeholder="Enter Customer Secret">
            </div>
            <div class="col-md-2 d-grid">
              <button id="saveCredsBtn" class="btn btn-outline-primary touch-target">Save</button>
            </div>
            <div class="col-md-2 d-grid">
              <button id="clearCredsBtn" class="btn btn-outline-secondary touch-target">Clear</button>
            </div>
            <div class="col-md-2 d-grid">
              <button id="connectBtn" class="btn btn-primary touch-target">Connect</button>
            </div>
          </div>
          <div class="form-text mt-2">For internal use. Credentials are stored in this device's browser localStorage.</div>
        </div>
      </div>
    </div>
    <div id="devicesGrid" class="row g-3 row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4">
    </div>
  </main>
  <div class="container mb-4 d-flex gap-3">
    <a href="#" id="openSettingsLink">Settings</a>
    <a href="#" id="refreshLink">Refresh now</a>
    <a href="#" id="hiddenLink">Hidden (0)</a>
  </div>
  <div class="modal fade" id="deviceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deviceModalTitle">Device</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="deviceAlert"></div>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="card h-100">
                <div class="card-header">Information</div>
                <div class="card-body">
                  <div><strong>Name: </strong><span id="devName"></span></div>
                  <div><strong>Type: </strong><span id="devType"></span></div>
                  <div><strong>ID: </strong><code class="small" id="devId"></code></div>
                  <div class="mt-2"><strong>Status: </strong><span id="devOnline"></span></div>
                  <div><strong>Sub: </strong><span id="devSub"></span></div>
                  <div><strong>Time zone: </strong><span id="devTz"></span></div>
                  <div><strong>Active: </strong><span id="devActive"></span></div>
                  <div><strong>Updated: </strong><span id="devUpdated"></span></div>
                </div>
              </div>
            </div>
            <div class="col-md-6 d-flex flex-column">
              <div class="card mb-3 flex-grow-1">
                <div class="card-header">Status</div>
                <div class="card-body">
                  <ul id="statusList" class="list-group list-group-flush small"></ul>
                </div>
              </div>
              <div id="commandsCard" class="card d-none">
                <div class="card-header">Commands</div>
                <div class="card-body">
                  <div class="row g-2 align-items-end">
                    <div class="col-md-6">
                      <label class="form-label">Temperature (°C)</label>
                      <input id="tempSetInput" type="number" step="0.5" class="form-control" placeholder="e.g. 20">
                    </div>
                    <div class="col-md-3 d-grid">
                      <button id="sendTempBtn" class="btn btn-primary touch-target">Send temp_set</button>
                    </div>
                  </div>
                  <div class="form-text mt-2">temp_set value in API is in tenths (e.g., 20.0°C → 200)</div>
                </div>
              </div>
            </div>
          </div>
          <div id="subDevicesCard" class="card mt-3 d-none">
            <div class="card-header">Sub-devices</div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Type</th>
                      <th>Status</th>
                      <th>Active</th>
                      <th>Updated</th>
                      <th>ID</th>
                    </tr>
                  </thead>
                  <tbody id="subDevicesBody">
                    <tr><td colspan="6" class="text-center text-muted">None</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="toggleHideBtn" class="btn btn-outline-warning">Hide</button>
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Settings</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3 align-items-end">
            <div class="col-md-12">
              <label class="form-label">Customer Key</label>
              <input id="clientIdInputModal" class="form-control" placeholder="Enter Customer Key">
            </div>
            <div class="col-md-12">
              <label class="form-label">Customer Secret</label>
              <input id="clientSecretInputModal" type="password" class="form-control" placeholder="Enter Customer Secret">
            </div>
            <div class="col-md-12">
              <label class="form-label">Refresh Interval (seconds)</label>
              <input id="refreshSecondsInputModal" type="number" class="form-control" placeholder="60" min="5" max="3600">
            </div>
          </div>
          <div class="form-text mt-2">For internal use. Credentials are stored in this device's browser localStorage.</div>
        </div>
        <div class="modal-footer">
          <button id="saveCredsBtnModal" class="btn btn-outline-primary">Save</button>
          <button id="clearCredsBtnModal" class="btn btn-outline-secondary">Clear</button>
          <button id="connectBtnModal" class="btn btn-primary">Connect</button>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const TOKEN_URL = 'https://api.danfoss.com/oauth2/token';
  const API_BASE = 'https://api.danfoss.com/ally';

  let accessToken = null;
  let tokenExpiresAt = 0;
  let allDevices = [];
  let isRefreshing = false;
  let nextRefreshAt = 0;
  let refreshTimeoutId = null;
  let viewMode = 'active'; // 'active' or 'hidden'

  function epochToLocal(ts) {
    if (!ts) return '';
    const ms = ts < 2e12 ? ts * 1000 : ts;
    return new Date(ms).toLocaleString();
  }

  function secsLeft() {
    if (!accessToken || !tokenExpiresAt) return 0;
    return Math.max(0, Math.floor((tokenExpiresAt - Date.now()) / 1000));
  }

  function setTokenInfo(text) {
    document.getElementById('tokenInfo').textContent = text;
  }

  function getStoredCreds() {
    const cid = localStorage.getItem('ally_client_id') || '';
    const sec = localStorage.getItem('ally_client_secret') || '';
    return { cid, sec };
  }

  function getRefreshSeconds() {
    const stored = localStorage.getItem('ally_refresh_seconds');
    if (stored) {
      const val = parseInt(stored, 10);
      if (!isNaN(val) && val >= 5 && val <= 3600) return val;
    }
    return 60;
  }

  function setRefreshSeconds(seconds) {
    localStorage.setItem('ally_refresh_seconds', String(seconds));
  }

  function getHiddenDevices() {
    const stored = localStorage.getItem('ally_hidden_devices');
    if (!stored) return [];
    try {
      const parsed = JSON.parse(stored);
      return Array.isArray(parsed) ? parsed : [];
    } catch {
      return [];
    }
  }

  function isDeviceHidden(deviceId) {
    return getHiddenDevices().includes(String(deviceId));
  }

  function hideDevice(deviceId) {
    const hidden = getHiddenDevices();
    const id = String(deviceId);
    if (!hidden.includes(id)) {
      hidden.push(id);
      localStorage.setItem('ally_hidden_devices', JSON.stringify(hidden));
      updateHiddenCount();
    }
  }

  function unhideDevice(deviceId) {
    const hidden = getHiddenDevices();
    const id = String(deviceId);
    const filtered = hidden.filter(h => h !== id);
    localStorage.setItem('ally_hidden_devices', JSON.stringify(filtered));
    updateHiddenCount();
  }

  function updateHiddenCount() {
    const count = getHiddenDevices().length;
    const link = document.getElementById('hiddenLink');
    if (link) link.textContent = `Hidden (${count})`;
  }

  function loadCredsToUI() {
    const { cid, sec } = getStoredCreds();
    document.getElementById('clientIdInput').value = cid || '';
    document.getElementById('clientSecretInput').value = sec || '';
  }

  function saveCreds() {
    const cid = document.getElementById('clientIdInput').value.trim();
    const sec = document.getElementById('clientSecretInput').value.trim();
    if (cid) localStorage.setItem('ally_client_id', cid);
    if (sec) localStorage.setItem('ally_client_secret', sec);
  }

  function clearCreds() {
    localStorage.removeItem('ally_client_id');
    localStorage.removeItem('ally_client_secret');
    document.getElementById('clientIdInput').value = '';
    document.getElementById('clientSecretInput').value = '';
  }

  async function getAccessToken(force = false) {
    const left = secsLeft();
    if (!force && accessToken && left > 5) return accessToken;

    const { cid, sec } = getStoredCreds();
    if (!cid || !sec) throw new Error('Missing credentials');

    setTokenInfo('Fetching token');
    const basic = btoa(`${cid}:${sec}`);

    const res = await fetch(TOKEN_URL, {
      method: 'POST',
      headers: {
        'Authorization': `Basic ${basic}`,
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: new URLSearchParams({ grant_type: 'client_credentials' }).toString(),
      cache: 'no-store',
      mode: 'cors'
    });

    if (res.status === 429) {
      await new Promise(r => setTimeout(r, 500));
      return getAccessToken(force);
    }

    if (!res.ok) {
      const txt = await res.text().catch(() => '');
      throw new Error(`Token error: ${res.status} ${res.statusText} ${txt}`);
    }

    const data = await res.json();
    accessToken = data.access_token;
    const ttl = Math.max(60, (data.expires_in || 3600) - 60);
    tokenExpiresAt = Date.now() + ttl * 1000;
    setTokenInfo(`Connected, ~${Math.floor(ttl)}s left`);
    return accessToken;
  }

  async function apiFetch(path, init = {}, retry = true) {
    const token = await getAccessToken();
    const res = await fetch(`${API_BASE}${path}`, {
      ...init,
      headers: {
        ...(init.headers || {}),
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/json'
      },
      cache: 'no-store',
      mode: 'cors'
    });

    if (res.status === 401 && retry) {
      await getAccessToken(true);
      return apiFetch(path, init, false);
    }

    return res;
  }

  async function loadDevices() {
    try {
      const res = await apiFetch('/devices');
      if (res.status === 429) {
        await new Promise(r => setTimeout(r, 500));
        return loadDevices();
      }
      if (!res.ok) {
        const t = await res.text().catch(() => '');
        throw new Error(`HTTP ${res.status}: ${t || res.statusText}`);
      }
      const data = await res.json();
      allDevices = Array.isArray(data.result) ? data.result : [];
      renderDevicesGrid(allDevices);
      updateMetricsInBackground(allDevices);
    } catch (e) {
      renderDevicesGrid([]);
      alert(e.message || String(e));
    }
  }

  function getTempSetFromStatus(status) {
    if (!Array.isArray(status)) return null;
    const item = status.find(s => s && s.code === 'temp_set' && typeof s.value === 'number');
    if (!item) return null;
    return (item.value / 10).toFixed(1);
  }

  function parseTempCFromStatus(status) {
    if (!Array.isArray(status)) return null;
    for (const s of status) {
      if (!s || typeof s.value !== 'number') continue;
      const code = String(s.code || '').toLowerCase();
      if ((code.includes('temp') || code.includes('temperature')) &&
          !code.includes('set') &&
          !code.includes('alarm') &&
          !code.includes('range') &&
          !code.includes('upper') &&
          !code.includes('lower') &&
          !code.includes('target') &&
          !code.endsWith('_f')) {
        let v = s.value;
        if (v > 100) v = v / 10;
        if (v < -50 || v > 80) continue;
        return v.toFixed(1);
      }
    }
    return null;
  }

  function parseHumidityFromStatus(status) {
    if (!Array.isArray(status)) return null;
    // First try to find humidity_value specifically
    const humidityValueItem = status.find(s => s && String(s.code || '').toLowerCase() === 'humidity_value');
    if (humidityValueItem && humidityValueItem.value != null) {
      const raw = humidityValueItem.value;
      const num = typeof raw === 'number' ? raw : (typeof raw === 'string' ? parseFloat(raw.replace(',', '.')) : NaN);
      if (!Number.isNaN(num)) {
        let v = num;
        // Handle tenth-based values (e.g. 650 -> 65)
        if (v > 100 && v <= 1000) v = v / 10;
        if (v > 1000) v = v / 100;
        if (v >= 0 && v <= 100) return String(Math.round(v));
      }
    }
    // Fallback to any humidity field
    for (const s of status) {
      if (!s || s.value == null) continue;
      const code = String(s.code || '').toLowerCase();
      if (code.includes('humidity') || code.includes('humid')) {
        const raw = s.value;
        const num = typeof raw === 'number' ? raw : (typeof raw === 'string' ? parseFloat(raw.replace(',', '.')) : NaN);
        if (Number.isNaN(num)) continue;
        let v = num;
        if (v > 100 && v <= 1000) v = v / 10;
        if (v > 1000) v = v / 100;
        if (v < 0 || v > 100) continue;
        return String(Math.round(v));
      }
    }
    return null;
  }

  function parseBatteryFromStatus(status) {
    if (!Array.isArray(status)) return null;
    for (const s of status) {
      if (!s || typeof s.value !== 'number') continue;
      const code = String(s.code || '').toLowerCase();
      if (code.includes('battery') || code.includes('batt')) {
        let v = s.value;
        if (v > 1000) v = v / 10;
        if (v > 100) v = v / 10;
        if (v < 0 || v > 100) continue;
        return String(Math.round(v));
      }
    }
    return null;
  }

  function renderDevicesGrid(list) {
    const grid = document.getElementById('devicesGrid');
    grid.innerHTML = '';

    // Filter based on view mode
    const filtered = list.filter(d => {
      const hidden = isDeviceHidden(d.id);
      return viewMode === 'hidden' ? hidden : !hidden;
    });

    // Update alert visibility
    const alert = document.getElementById('hiddenModeAlert');
    if (alert) {
      if (viewMode === 'hidden') {
        alert.classList.remove('d-none');
      } else {
        alert.classList.add('d-none');
      }
    }

    if (!filtered.length) {
      const col = document.createElement('div');
      col.className = 'col';
      const msg = viewMode === 'hidden' ? 'No hidden devices' : 'No data';
      col.innerHTML = `<div class="text-center text-muted py-5">${msg}</div>`;
      grid.appendChild(col);
      return;
    }

    const items = [...filtered].sort((a,b)=>{
      const at=(a.device_type||'').toLowerCase();
      const bt=(b.device_type||'').toLowerCase();
      if (at<bt) return -1; if (at>bt) return 1;
      const an=(a.name||'').toLowerCase();
      const bn=(b.name||'').toLowerCase();
      if (an<bn) return -1; if (an>bn) return 1; return 0;
    });

    for (const d of items) {
      const col = document.createElement('div');
      col.className = 'col';

      const tempSet = getTempSetFromStatus(d.status);
      const tempNow = parseTempCFromStatus(d.status);
      const humNow = parseHumidityFromStatus(d.status);
      const battNow = parseBatteryFromStatus(d.status);
      const nameHtml = `<div class="device-name">${d.name || ''}</div>`;
      const typeHtml = `<div class="device-type">${d.device_type || ''}</div>`;
      let metricsHtml = '';
      if (tempNow != null) metricsHtml += `<div class="mt-2 text-center"><div id="temp-${d.id}" class="temp-value">${tempNow} °C</div><div class="text-muted small">Temperature <span id="tstat-${d.id}" class="status-pill" style="display:none"></span></div><svg class="sparkline mt-2" width="100%" viewBox="0 0 100 36" preserveAspectRatio="none"><path d=""/></svg></div>`;
      metricsHtml += `<ul id="metrics-${d.id}" class="metrics-inline">`;
      if (humNow != null) metricsHtml += `<li class="chip"><span class="label">Humidity:</span> <strong>${humNow}%</strong></li>`;
      if (battNow != null) {
        const battVal = parseInt(battNow, 10);
        const battClass = battVal < 30 ? 'text-danger' : '';
        metricsHtml += `<li class="chip"><span class="label">Battery:</span> <strong class="${battClass}">${battNow}%</strong></li>`;
      }
      if (tempSet != null) metricsHtml += `<li class="chip"><span class="label">Setpoint:</span> <strong>${tempSet}°C</strong></li>`;
      metricsHtml += `</ul>`;

      col.innerHTML = `
        <div class="card card-device h-100 ${typeToBgClass(d.device_type)}" data-id="${d.id}" style="cursor:pointer">
          <div class="card-body d-flex flex-column">
            <div class="d-flex align-items-start justify-content-between">
              <div class="me-2">
                ${nameHtml}
                ${typeHtml}
              </div>
              <div>${d.online ? '<span class="badge badge-status badge-dark">Online</span>' : '<span class="badge badge-status bg-secondary">Offline</span>'}</div>
            </div>
            ${metricsHtml}
          </div>
        </div>
      `;

      grid.appendChild(col);
    }

    grid.querySelectorAll('[data-id]').forEach(el => { el.addEventListener('click', () => openDeviceModal(el.getAttribute('data-id'))); });
  }

  // search removed

  let deviceModal;
  function ensureModal() {
    if (!deviceModal) deviceModal = new bootstrap.Modal(document.getElementById('deviceModal'));
    return deviceModal;
  }

  async function openDeviceModal(deviceId) {
    setDeviceAlert();
    document.getElementById('deviceModalTitle').textContent = 'Device';
    document.getElementById('devId').textContent = deviceId;
    document.getElementById('devName').textContent = '';
    document.getElementById('devType').textContent = '';
    document.getElementById('devOnline').innerHTML = '';
    document.getElementById('devSub').textContent = '';
    document.getElementById('devTz').textContent = '';
    document.getElementById('devActive').textContent = '';
    document.getElementById('devUpdated').textContent = '';
    document.getElementById('statusList').innerHTML = '<li class="list-group-item">Loading</li>';
    document.getElementById('subDevicesBody').innerHTML = '<tr><td colspan="6" class="text-center text-muted">Loading</td></tr>';
    document.getElementById('tempSetInput').value = '';

    ensureModal().show();

    try {
      const [infoRes, statusRes, subsRes] = await Promise.all([
        apiFetch(`/devices/${encodeURIComponent(deviceId)}`),
        apiFetch(`/devices/${encodeURIComponent(deviceId)}/status`),
        apiFetch(`/devices/${encodeURIComponent(deviceId)}/sub-devices`)
      ]);

      if (!infoRes.ok) throw new Error(`Device info error: ${infoRes.status}`);

      const info = await infoRes.json();
      const dev = info.result || {};

      document.getElementById('deviceModalTitle').textContent = dev.name || 'Device';
      document.getElementById('devName').textContent = dev.name || '';
      document.getElementById('devType').textContent = dev.device_type || '';
      document.getElementById('devId').textContent = dev.id || deviceId;
      document.getElementById('devOnline').innerHTML = dev.online ? '<span class="badge bg-success">Online</span>' : '<span class="badge bg-secondary">Offline</span>';
      document.getElementById('devSub').textContent = dev.sub === true ? 'Yes' : dev.sub === false ? 'No' : '';
      document.getElementById('devTz').textContent = dev.time_zone || '';
      document.getElementById('devActive').textContent = epochToLocal(dev.active_time);
      document.getElementById('devUpdated').textContent = epochToLocal(dev.update_time);

      const statusUl = document.getElementById('statusList');
      statusUl.innerHTML = '';

      if (statusRes.ok) {
        const s = await statusRes.json();
        const items = s.result || [];
        if (!items.length) {
          statusUl.innerHTML = '<li class="list-group-item text-muted">No status</li>';
        } else {
          for (const it of items) {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between';
            li.innerHTML = `<span>${it.code}</span><code class="small">${String(it.value)}</code>`;
            statusUl.appendChild(li);
            if (it.code === 'temp_set' && typeof it.value === 'number') {
              const c = (it.value / 10).toFixed(1);
              document.getElementById('tempSetInput').value = c;
            }
          }
        }
      } else {
        statusUl.innerHTML = `<li class="list-group-item text-danger">Status error: ${statusRes.status}</li>`;
      }

      const subBody = document.getElementById('subDevicesBody');
      if (subsRes.ok) {
        const subs = await subsRes.json();
        const list = subs.result || [];
        if (!list.length) {
          subBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">None</td></tr>';
          const subDevicesCard = document.getElementById('subDevicesCard');
          if (subDevicesCard) subDevicesCard.classList.add('d-none');
        } else {
          const subDevicesCard = document.getElementById('subDevicesCard');
          if (subDevicesCard) subDevicesCard.classList.remove('d-none');
          subBody.innerHTML = '';
          for (const sd of list) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${sd.name || ''}</td>
              <td>${sd.device_type || ''}</td>
              <td>${sd.online ? '<span class="badge bg-success">Online</span>' : '<span class="badge bg-secondary">Offline</span>'}</td>
              <td>${epochToLocal(sd.active_time)}</td>
              <td>${epochToLocal(sd.update_time)}</td>
              <td><code class="small">${sd.id || ''}</code></td>
            `;
            subBody.appendChild(tr);
          }
        }
      } else {
        subBody.innerHTML = `<tr><td colspan="6" class="text-danger">Sub-devices error: ${subsRes.status}</td></tr>`;
        const subDevicesCard = document.getElementById('subDevicesCard');
        if (subDevicesCard) subDevicesCard.classList.remove('d-none');
      }

      const commandsCard = document.getElementById('commandsCard');
      if (commandsCard) {
        commandsCard.classList.add('d-none');
      }

      document.getElementById('sendTempBtn').onclick = () => sendTempSet(deviceId);

      // Update Hide/Unhide button
      const toggleHideBtn = document.getElementById('toggleHideBtn');
      if (toggleHideBtn) {
        const hidden = isDeviceHidden(deviceId);
        toggleHideBtn.textContent = hidden ? 'Unhide' : 'Hide';
        toggleHideBtn.onclick = () => {
          if (isDeviceHidden(deviceId)) {
            unhideDevice(deviceId);
          } else {
            hideDevice(deviceId);
          }
          renderDevicesGrid(allDevices);
          ensureModal().hide();
        };
      }
    } catch (e) {
      setDeviceAlert('danger', e.message || String(e));
    }
  }

  function setDeviceAlert(type, msg) {
    const el = document.getElementById('deviceAlert');
    if (!el) return;
    if (!type || !msg) {
      el.innerHTML = '';
      return;
    }
    el.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
  }

  async function sendTempSet(deviceId) {
    setDeviceAlert();
    const val = parseFloat(document.getElementById('tempSetInput').value);
    if (isNaN(val)) {
      setDeviceAlert('warning', 'Invalid temperature value.');
      return;
    }

    const apiValue = Math.round(val * 10);

    try {
      const res = await apiFetch(`/devices/${encodeURIComponent(deviceId)}/commands`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ commands: [{ code: 'temp_set', value: apiValue }] })
      });

      if (res.status === 429) {
        await new Promise(r => setTimeout(r, 500));
        return sendTempSet(deviceId);
      }

      if (!res.ok) {
        const t = await res.text().catch(() => '');
        throw new Error(`Command failed: ${res.status} ${t || res.statusText}`);
      }

      setDeviceAlert('success', `Temperature set (${val.toFixed(1)} °C).`);

      const statusRes = await apiFetch(`/devices/${encodeURIComponent(deviceId)}/status`);
      if (statusRes.ok) {
        const s = await statusRes.json();
        const statusUl = document.getElementById('statusList');
        statusUl.innerHTML = '';
        const items = s.result || [];
        if (!items.length) {
          statusUl.innerHTML = '<li class="list-group-item text-muted">No status</li>';
        } else {
          for (const it of items) {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between';
            li.innerHTML = `<span>${it.code}</span><code class="small">${String(it.value)}</code>`;
            statusUl.appendChild(li);
          }
        }
      }
    } catch (e) {
      setDeviceAlert('danger', e.message || String(e));
    }
  }

  function scheduleAutoRefresh(ms=null){ const link=document.getElementById('refreshLink'); if (refreshTimeoutId) { clearTimeout(refreshTimeoutId); refreshTimeoutId=null; } const refreshMs = ms !== null ? ms : (getRefreshSeconds() * 1000); nextRefreshAt=Date.now()+refreshMs; const tick=()=>{ const now=Date.now(); const left=Math.max(0, Math.ceil((nextRefreshAt-now)/1000)); if (link) link.textContent = left>0 ? `Refresh now (${left}s)` : 'Refresh now'; if (left<=0){ refreshTimeoutId=setTimeout(async ()=>{ refreshTimeoutId=null; await triggerRefresh(true); }, 0); } else { refreshTimeoutId=setTimeout(tick, 1000); } }; tick(); }
  async function triggerRefresh(auto=false){ if (isRefreshing) return; isRefreshing=true; try { await getAccessToken(true); await loadDevices(); } finally { isRefreshing=false; scheduleAutoRefresh(); } }

  const tempHistory = new Map();
  function addTempSample(deviceId, tempC){ if (tempC==null) return; const key=String(deviceId); const arr=tempHistory.get(key)||[]; arr.push({ t: Date.now(), v: Number(tempC) }); if (arr.length>50) arr.shift(); tempHistory.set(key, arr); drawSparkline(key); }
  function drawSparkline(deviceId){ const card = document.querySelector(`[data-id="${deviceId}"]`); if (!card) return; const svg = card.querySelector('svg.sparkline path'); if (!svg) return; const arr = tempHistory.get(String(deviceId))||[]; if (!arr.length){ svg.setAttribute('d',''); return; } const values = arr.map(p=>p.v); const min = Math.min(...values); const max = Math.max(...values); const span = Math.max(0.1, max-min); const n = values.length; const pts = values.map((v,i)=>{ const x = (i/(n-1||1))*100; const y = 36 - ((v-min)/span)*36; return `${x},${y}`; }); svg.setAttribute('d', `M ${pts.join(' L ')}`); }

  async function updateMetricsInBackground(list){ const concurrency=4; let idx=0; const workers=Array.from({length:Math.min(concurrency,list.length)},()=> (async function(){ while(idx<list.length){ const i=idx++; const d=list[i]; try{ const res=await apiFetch(`/devices/${encodeURIComponent(d.id)}/status`); if(!res.ok) continue; const s=await res.json(); const st=s.result||[]; const t=parseTempCFromStatus(st); if (t!=null) addTempSample(d.id, t); const h=parseHumidityFromStatus(st); const b=parseBatteryFromStatus(st); const set=getTempSetFromStatus(st); const metrics=document.getElementById(`metrics-${d.id}`); if (metrics){ let html=''; if (h!=null) html+=`<li class=\"chip\"><span class=\"label\">Humidity:</span> <strong>${h}%</strong></li>`; if (b!=null) { const bVal=parseInt(b,10); const bClass=bVal<30?'text-danger':''; html+=`<li class=\"chip\"><span class=\"label\">Battery:</span> <strong class=\"${bClass}\">${b}%</strong></li>`; } if (set!=null) html+=`<li class=\"chip\"><span class=\"label\">Setpoint:</span> <strong id=\"set-${d.id}\">${set}°C</strong></li>`; metrics.innerHTML=html; }
            // color temperature if below setpoint
            const tempEl=document.getElementById(`temp-${d.id}`);
            const setEl=document.getElementById(`set-${d.id}`);
            if (tempEl && set!=null){ const cur=parseFloat(String(t)); const sp=parseFloat(String(set)); if (!Number.isNaN(cur) && !Number.isNaN(sp)){ if (cur < sp) tempEl.classList.add('temp-low'); else tempEl.classList.remove('temp-low'); tempEl.textContent = `${cur.toFixed(1)} °C`; } }
            // status pill
            const pill=document.getElementById(`tstat-${d.id}`);
            if (pill){ let label=''; let cls=''; const lower = (code)=> String(code||'').toLowerCase(); const modeItem = st.find(x=> lower(x.code)==='mode'); const heatItem = st.find(x=> lower(x.code).includes('heat') || lower(x.code).includes('heating'));
              const val = modeItem?.value || heatItem?.value || '';
              const sval = String(val).toLowerCase();
              if (sval.includes('preheat') || sval.includes('pre-heating')) { label='preheating'; cls='status-preheat'; }
              else if (sval.includes('heat') || sval==='on' || sval==='true') { label='heating'; cls='status-heating'; }
              pill.className = `status-pill ${cls}`; pill.textContent = label; pill.style.display = label ? 'inline-block':'none'; }
          }catch(e){}
        }
      })());
      await Promise.all(workers);
  }

  function typeToBgClass(type){ const t=(type||'').toLowerCase(); if(!t) return 'type-bg-0'; let hash=0; for(let i=0;i<t.length;i++){ hash = (hash*31 + t.charCodeAt(i)) >>> 0; } const idx = hash % 12; return `type-bg-${idx}`; }

  document.getElementById('saveCredsBtn').addEventListener('click', () => {
    saveCreds();
    alert('Saved.');
  });

  document.getElementById('clearCredsBtn').addEventListener('click', () => {
    clearCreds();
    alert('Cleared.');
  });

  document.getElementById('connectBtn').addEventListener('click', async () => {
    try {
      await getAccessToken(true);
      await loadDevices();
      scheduleAutoRefresh();
    } catch (e) {
      alert(e.message || String(e));
    }
  });

  document.getElementById('refreshLink').addEventListener('click', async (e) => { e.preventDefault(); await triggerRefresh(false); });

  document.getElementById('hiddenLink').addEventListener('click', (e) => {
    e.preventDefault();
    viewMode = 'hidden';
    renderDevicesGrid(allDevices);
  });

  document.getElementById('showActiveBtn').addEventListener('click', () => {
    viewMode = 'active';
    renderDevicesGrid(allDevices);
  });

  let settingsModal;
  function loadCredsToModal() {
    const { cid, sec } = getStoredCreds();
    const refreshSec = getRefreshSeconds();
    const idEl = document.getElementById('clientIdInputModal');
    const secEl = document.getElementById('clientSecretInputModal');
    const refreshEl = document.getElementById('refreshSecondsInputModal');
    if (idEl) idEl.value = cid || '';
    if (secEl) secEl.value = sec || '';
    if (refreshEl) refreshEl.value = String(refreshSec);
  }
  document.addEventListener('DOMContentLoaded', () => {
    const link = document.getElementById('openSettingsLink');
    if (link) {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        if (!settingsModal) settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
        loadCredsToModal();
        settingsModal.show();
      });
    }
    const saveBtn = document.getElementById('saveCredsBtnModal');
    const clearBtn = document.getElementById('clearCredsBtnModal');
    const connectBtn = document.getElementById('connectBtnModal');
    if (saveBtn) saveBtn.addEventListener('click', () => {
      const idEl = document.getElementById('clientIdInputModal');
      const secEl = document.getElementById('clientSecretInputModal');
      const refreshEl = document.getElementById('refreshSecondsInputModal');
      if (idEl && idEl.value) localStorage.setItem('ally_client_id', idEl.value.trim());
      if (secEl && secEl.value) localStorage.setItem('ally_client_secret', secEl.value.trim());
      if (refreshEl && refreshEl.value) {
        const val = parseInt(refreshEl.value, 10);
        if (!isNaN(val) && val >= 5 && val <= 3600) {
          setRefreshSeconds(val);
        }
      }
      alert('Saved.');
    });
    if (clearBtn) clearBtn.addEventListener('click', () => {
      localStorage.removeItem('ally_client_id');
      localStorage.removeItem('ally_client_secret');
      localStorage.removeItem('ally_refresh_seconds');
      const idEl = document.getElementById('clientIdInputModal');
      const secEl = document.getElementById('clientSecretInputModal');
      const refreshEl = document.getElementById('refreshSecondsInputModal');
      if (idEl) idEl.value = '';
      if (secEl) secEl.value = '';
      if (refreshEl) refreshEl.value = '60';
      alert('Cleared.');
    });
    if (connectBtn) connectBtn.addEventListener('click', async () => {
      try {
        const idEl = document.getElementById('clientIdInputModal');
        const secEl = document.getElementById('clientSecretInputModal');
        const refreshEl = document.getElementById('refreshSecondsInputModal');
        if (idEl && idEl.value) localStorage.setItem('ally_client_id', idEl.value.trim());
        if (secEl && secEl.value) localStorage.setItem('ally_client_secret', secEl.value.trim());
        if (refreshEl && refreshEl.value) {
          const val = parseInt(refreshEl.value, 10);
          if (!isNaN(val) && val >= 5 && val <= 3600) {
            setRefreshSeconds(val);
          }
        }
        await getAccessToken(true);
        await loadDevices();
        scheduleAutoRefresh();
        if (settingsModal) settingsModal.hide();
      } catch (e) {
        alert(e.message || String(e));
      }
    });
  });

  (async function init() {
    loadCredsToUI();
    updateHiddenCount();
    const { cid, sec } = getStoredCreds();
    if (!cid || !sec) {
      setTimeout(() => {
        if (!settingsModal) settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
        loadCredsToModal();
        settingsModal.show();
      }, 500);
      return;
    }
    try {
      await getAccessToken(true);
      await loadDevices();
      scheduleAutoRefresh();
    } catch (e) {}
  })();
</script>